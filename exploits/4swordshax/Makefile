ifeq ($(strip $(REGION)),)
$(error "Set the REGION Makefile parameter.")
endif

HAXID	:=	4

include ../haxx_rules

REGCODE	:=	00
SREGCODE	:=  0
ifeq ($(REGION),USA)
	REGCODE	:=	45
	SREGCODE	:=	1
endif
ifeq ($(REGION),EUR)
	REGCODE	:=	56
	SREGCODE	:=	2
endif
ifeq ($(REGION),JP)
	REGCODE	:=	4A
	SREGCODE	:=	0
endif
ifeq ($(REGCODE),00)
	$(error "Unsupported region.")
endif

all:	all.dat

clean:
	@make clean -C ../minitwlpayload
	rm -f $(HAXNAME).elf all.dat ../minitwlpayload/payload.dat $(TID)$(REGCODE)hax_crypt.sav.$(HAXVER) $(HAXNAME)_crypt.ban.$(HAXVER) $(TID)$(REGCODE).tmd.sha1 $(TID)$(REGCODE)hax.savedata.sha1 $(HAXNAME).banner.sha1

all.dat: $(HAXNAME).elf
	arm-none-eabi-objcopy -O binary $(HAXNAME).elf all.dat
	cp $(TID)$(REGCODE)in.savedata $(TID)$(REGCODE)hax.savedata
	sudo mount -o loop $(TID)$(REGCODE)hax.savedata $(HAXNAME)
	sudo cp ./all.dat $(HAXNAME)/savedata/all.dat
	sudo cp ../minitwlpayload/payload.dat $(HAXNAME)/savedata/payload.dat
	sudo umount $(HAXNAME)
	cp $(TID)$(REGCODE)hax.savedata public.sav
	../dumprawsav/dumprawsav --insav=$(CURDIR)/$(TID)$(REGCODE)hax.savedata --inban=$(CURDIR)/$(HAXNAME).banner --cryptsav=$(CURDIR)/$(TID)$(REGCODE)hax_crypt.sav.$(HAXVER) --cryptban=$(CURDIR)/$(HAXNAME)_crypt.ban.$(HAXVER) --hashsav=$(TID)$(REGCODE)hax.savedata.sha1 --hashban=$(HAXNAME).banner.sha1

$(HAXNAME).elf:	$(HAXNAME).s ../minitwlpayload/payload.dat
	arm-none-eabi-gcc -x assembler-with-cpp -nostartfiles -nostdlib -DREGCODE=$(SREGCODE) -DPAYLOAD_SIZE=`stat -L -c %s ../minitwlpayload/payload.dat` $(HAXNAME).s -o $(HAXNAME).elf

../minitwlpayload/payload.dat:
	@make -C ../minitwlpayload
